#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
Usage: ops/bin/close
USAGE
}

die() {
  echo "ERROR: $*" >&2
  exit 1
}

for arg in "$@"; do
  case "$arg" in
    -h|--help)
      usage
      exit 0
      ;;
    *)
      die "Unknown argument: $arg"
      ;;
  esac
done

if ! command -v git >/dev/null 2>&1; then
  die "git is required but was not found on PATH."
fi

if ! repo_root="$(git rev-parse --show-toplevel 2>/dev/null)"; then
  die "git repo not found. Run from repo root."
fi

if [[ "$(pwd -P)" != "$repo_root" ]]; then
  die "Run from repo root: $repo_root"
fi

remote_url="$(git remote get-url origin 2>/dev/null || true)"
if [[ -n "$remote_url" ]]; then
  repo_name="$(basename -s .git "$remote_url")"
else
  repo_name="$(basename "$repo_root")"
fi

branch="$(git rev-parse --abbrev-ref HEAD)"
head_short="$(git rev-parse --short HEAD)"
status_raw="$(git status --porcelain)"
if [[ -z "$status_raw" ]]; then
  status_summary="clean"
  status_detail="clean"
else
  status_summary="dirty"
  status_detail="$status_raw"
fi

last_commit="$(git log -1 --oneline)"

cat <<EOF
===== SESSION SNAPSHOT (receipt) =====
Repo: $repo_name
Branch: $branch
HEAD: $head_short
Status: $status_summary
Status detail:
$status_detail
Last commit: $last_commit

What we just did:
- 

What's next:
- 
===== END SESSION SNAPSHOT =====
EOF
