#!/usr/bin/env bash
set -euo pipefail

format="chatgpt"

usage() {
  cat <<'USAGE'
Usage: ops/bin/open [--format=chatgpt|gemini]
USAGE
}

die() {
  echo "ERROR: $*" >&2
  exit 1
}

for arg in "$@"; do
  case "$arg" in
    --format=chatgpt|--format=gemini)
      format="${arg#--format=}"
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      die "Unknown argument: $arg"
      ;;
  esac
done

required_files=(
  "PROJECT_TRUTH.md"
  "ops/init/icl/context_pack.json"
  "STATE_OF_PLAY.md"
  "PROJECT_MAP.md"
  "CANONICAL_TREE.md"
  "docs/00-INDEX.md"
  "ops/init/icl/launch_pack/CONTEXT_PACK.md"
  "ops/init/icl/launch_pack/AI_CONTEXT_SYNC.md"
)

missing=()
for path in "${required_files[@]}"; do
  if [[ ! -f "$path" ]]; then
    missing+=("$path")
  fi
done

if (( ${#missing[@]} > 0 )); then
  echo "ERROR: expected files missing. Run from repo root." >&2
  for path in "${missing[@]}"; do
    echo "  - $path" >&2
  done
  exit 1
fi

if [[ "$format" == "gemini" ]]; then
  mode_line="Mode: reviewer stance. Prioritize risks, regressions, and missing tests."
else
  mode_line="Mode: collaborator stance. Follow repo canon and request missing context."
fi

cat <<EOF
===== OPEN PROMPT =====
nukeCE OPEN PROMPT (Front Door v1)
Repo is truth. If a file/path isn't present, say so.
$mode_line

Constitution (Data Constitution):
- PROJECT_TRUTH.md

Canon pointers:
- ops/init/icl/context_pack.json
- STATE_OF_PLAY.md
- PROJECT_MAP.md
- CANONICAL_TREE.md
- docs/00-INDEX.md
- ops/init/icl/launch_pack/CONTEXT_PACK.md
- ops/init/icl/launch_pack/AI_CONTEXT_SYNC.md

Freshness Gate (operator fills from IDE/Git):
- Active branch name: ________
- HEAD short hash: ________
- DP id/date (if applicable): ________

Metadata Kit instruction:
- After approving work results, tell the assistant you approve and ask for Metadata Kit v1; assistant must emit it immediately.

What I need from you now (operator):
- branch name
- HEAD short hash
- what you want to do today (1 sentence)
===== END OPEN PROMPT =====
EOF
